<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SURGE PRO</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap');
        :root {
            --bg-main: #ffffff;
            --bg-side: #f0f4f9;
            --text-main: #1f1f1f;
            --text-sub: #444746;
            --hover-color: #e1e5ea;
            --surge-gradient: linear-gradient(70deg, #4285f4, #9b72cb, #d96570);
        }
        body { font-family: 'Noto Sans JP', sans-serif; background: var(--bg-main); color: var(--text-main); margin: 0; display: flex; height: 100vh; height: -webkit-fill-available; overflow: hidden; }
        
        /* サイドバー */
        #sidebar { 
            width: 260px; background: var(--bg-side); display: flex; flex-direction: column; padding: 12px; transition: 0.3s; z-index: 1000; flex-shrink: 0; 
            position: relative;
        }
        #sidebar.closed { margin-left: -260px; }
        
        @media (max-width: 768px) {
            #sidebar { position: fixed; height: 100%; box-shadow: 2px 0 10px rgba(0,0,0,0.1); width: 280px; }
            #sidebar.closed { margin-left: -280px; }
        }

        .menu-btn { width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; }
        .menu-btn:hover { background: var(--hover-color); }
        .new-chat { display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: #e6eaf1; border-radius: 24px; margin: 10px 0; cursor: pointer; font-size: 14px; font-weight: 500; }
        
        .history-container { flex: 1; overflow-y: auto; margin-top: 10px; }
        .history-label { font-size: 12px; font-weight: bold; padding: 10px; color: var(--text-sub); }
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 14px; border-radius: 10px; font-size: 14px; cursor: pointer; transition: 0.2s; }
        .history-item:hover { background: var(--hover-color); }
        .history-item span { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; }
        .delete-btn { opacity: 0.6; color: #999; padding: 4px; display: flex; align-items: center; }
        @media (min-width: 769px) { .delete-btn { opacity: 0; } .history-item:hover .delete-btn { opacity: 1; } }

        /* メインエリア */
        #main-container { flex: 1; display: flex; flex-direction: column; position: relative; min-width: 0; width: 100%; }
        header { padding: 8px 16px; display: flex; align-items: center; gap: 10px; height: 56px; flex-shrink: 0; }
        .logo { font-size: 18px; font-weight: 700; background: var(--surge-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        #chat-window { flex: 1; overflow-y: auto; padding: 10px 0; display: flex; flex-direction: column; align-items: center; scroll-behavior: smooth; }
        .chat-container { width: 92%; max-width: 700px; padding-bottom: 20px; }
        
        .message { margin-bottom: 24px; display: flex; flex-direction: column; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .user-msg { align-items: flex-end; }
        .user-text { background: #f0f4f9; padding: 10px 18px; border-radius: 20px; max-width: 85%; line-height: 1.6; font-size: 15px; word-break: break-all; }
        
        .ai-msg { align-items: flex-start; gap: 10px; }
        .ai-row { display: flex; gap: 10px; width: 100%; }
        .ai-icon { width: 28px; height: 28px; background: var(--surge-gradient); border-radius: 50%; flex-shrink: 0; margin-top: 4px; }
        .ai-text { line-height: 1.7; color: var(--text-main); white-space: pre-wrap; flex: 1; font-size: 15px; }

        .share-btn { font-size: 12px; color: #70757a; cursor: pointer; margin-top: 8px; margin-left: 38px; display: inline-flex; align-items: center; gap: 4px; }

        .greeting { margin-top: 10vh; text-align: center; width: 100%; }
        .greeting h1 { font-size: clamp(28px, 8vw, 48px); background: var(--surge-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0; }
        .greeting p { font-size: 18px; color: #c4c7c5; padding: 0 20px; }

        .bottom-area { padding: 10px 15px 20px; display: flex; flex-direction: column; align-items: center; background: #fff; }
        .input-wrapper { width: 100%; max-width: 768px; background: #f0f4f9; border-radius: 28px; padding: 4px 16px; display: flex; align-items: center; border: 1px solid transparent; }
        input { flex: 1; border: none; background: transparent; outline: none; font-size: 16px; height: 44px; min-width: 0; }
        .send-btn { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #4285f4; }
    </style>
</head>
<body>

    <nav id="sidebar" class="closed">
        <div class="menu-btn" onclick="toggleSidebar()">
            <svg width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
        </div>
        <div class="new-chat" onclick="location.reload()">
            <svg width="20" height="20" viewBox="0 0 24 24"><path fill="currentColor" d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
            新しいチャット
        </div>
        <div class="history-container">
            <div class="history-label">最近</div>
            <div id="history-list"></div>
        </div>
    </nav>

    <div id="main-container">
        <header>
            <div class="menu-btn" onclick="toggleSidebar()">
                <svg width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
            </div>
            <div class="logo">SURGE PRO</div>
        </header>

        <div id="chat-window">
            <div class="chat-container" id="chat-content">
                <div class="greeting" id="initial-view">
                    <h1>こんにちは</h1>
                    <p>今日はどんなお手伝いをしましょうか？</p>
                </div>
            </div>
        </div>

        <div class="bottom-area">
            <div class="input-wrapper">
                <input type="text" id="user-input" placeholder="メッセージを入力" autocomplete="off">
                <div class="send-btn" onclick="sendMsg()">
                    <svg width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                </div>
            </div>
            <div style="font-size: 10px; color: #70757a; margin-top: 8px; text-align: center;">SURGE PRO は間違いを表示することがあります。</div>
        </div>
    </div>

    <script>
        const WORKER_URL = "https://surge.proluce.workers.dev";
        let currentChatId = null;
        let chatHistory = [];

        window.onload = () => { refreshHistoryList(); };

        function refreshHistoryList() {
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = "";
            const allChats = JSON.parse(localStorage.getItem('surge_chats') || '{}');
            Object.keys(allChats).sort().reverse().forEach(id => {
                const chatData = allChats[id];
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                const titleSpan = document.createElement('span');
                titleSpan.innerText = chatData.title;
                titleSpan.onclick = () => { loadChat(id); if(window.innerWidth <= 768) toggleSidebar(); };
                const delBtn = document.createElement('div');
                delBtn.className = 'delete-btn';
                delBtn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentColor" d="M9 3v1H4v2h1v13a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V6h1V4h-5V3H9m0 5h2v11H9V8m4 0h2v11h-2V8z"/></svg>`;
                delBtn.onclick = (e) => { e.stopPropagation(); deleteChat(id); };
                historyItem.appendChild(titleSpan);
                historyItem.appendChild(delBtn);
                historyList.appendChild(historyItem);
            });
        }

        function deleteChat(id) {
            if (!confirm("この会話を削除しますか？")) return;
            const allChats = JSON.parse(localStorage.getItem('surge_chats') || '{}');
            delete allChats[id];
            localStorage.setItem('surge_chats', JSON.stringify(allChats));
            if (currentChatId === id) location.reload();
            refreshHistoryList();
        }

        function loadChat(id) {
            currentChatId = id;
            const allChats = JSON.parse(localStorage.getItem('surge_chats') || '{}');
            const chatData = allChats[id];
            const chatContent = document.getElementById('chat-content');
            if (document.getElementById('initial-view')) document.getElementById('initial-view').remove();
            chatContent.innerHTML = "";
            chatData.messages.forEach(msg => {
                msg.role === "user" ? appendUserMsg(msg.parts[0].text) : appendAiMsg(msg.parts[0].text);
            });
            chatHistory = chatData.messages;
            scrollToBottom();
        }

        function copyChat() {
            const textToCopy = chatHistory.map(m => `${m.role === 'user' ? 'ユーザー' : 'AI'}: ${m.parts[0].text}`).join('\n\n');
            navigator.clipboard.writeText(textToCopy).then(() => alert("会話をコピーしました。"));
        }

        function appendUserMsg(text) {
            document.getElementById('chat-content').innerHTML += `<div class="message user-msg"><div class="user-text">${text}</div></div>`;
        }

        function appendAiMsg(text, id = null) {
            const aiId = id || "ai-" + Date.now();
            document.getElementById('chat-content').innerHTML += `
                <div class="message ai-msg" id="${aiId}">
                    <div class="ai-row"><div class="ai-icon"></div><div class="ai-text">${text}</div></div>
                    <div class="share-btn" onclick="copyChat()"><svg width="12" height="12" viewBox="0 0 24 24"><path fill="currentColor" d="M16 1H4a2 2 0 0 0-2 2v14h2V3h12V1zm3 4H8a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2zm0 16H8V7h11v14z"/></svg>共有</div>
                </div>`;
            return aiId;
        }

        async function sendMsg() {
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            if (!text) return;
            if (document.getElementById('initial-view')) document.getElementById('initial-view').remove();
            if (!currentChatId) currentChatId = "chat-" + Date.now();
            appendUserMsg(text);
            input.value = "";
            const aiId = appendAiMsg("...");
            scrollToBottom();
            try {
                const response = await fetch(WORKER_URL, {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ inputs: text, history: chatHistory })
                });
                const data = await response.json();
                const aiResponseText = data[0].generated_text.replace("AI: ", "");
                chatHistory.push({ role: "user", parts: [{ text: text }] });
                chatHistory.push({ role: "model", parts: [{ text: aiResponseText }] });
                const allChats = JSON.parse(localStorage.getItem('surge_chats') || '{}');
                allChats[currentChatId] = { title: allChats[currentChatId]?.title || text, messages: chatHistory };
                localStorage.setItem('surge_chats', JSON.stringify(allChats));
                document.getElementById(aiId).querySelector('.ai-text').innerText = aiResponseText;
                refreshHistoryList();
                scrollToBottom();
            } catch (e) {
                document.getElementById(aiId).querySelector('.ai-text').innerText = "接続に問題が発生しました。";
            }
        }

        function scrollToBottom() {
            const win = document.getElementById('chat-window');
            win.scrollTop = win.scrollHeight;
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('closed');
        }

        document.getElementById('user-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') { sendMsg(); document.activeElement.blur(); }
        });
    </script>
</body>
</html>
